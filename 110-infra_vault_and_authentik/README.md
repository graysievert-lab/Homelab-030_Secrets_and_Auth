# Installing Vault and Authentik, setting up IdP, groups, and SSO
This project is dedicated to the creation of [Vault](https://developer.hashicorp.com/vault/docs/what-is-vault) instance for secrets management accompanied by SSO/IdP solution based on [Authentik](https://goauthentik.io/#comparison).

Vault is going to be installed as a bare-metal service on a Proxmox VM.
Authentik will be installed on the same VM as a stack of containers running on docker in a swarm mode. Swarm mode will help to securely generate and handle a few bootstrap secrets for the Authentik stack.

## Installation
Installation is scripted as follows:
1. Terraform will create a Rocky Linux VM on a Pproxmox node. Also, it will remotely update records in the local DNS zone via TSIG as the VM's IP address is pinned.
2. After the VM is started, the cloud-init script will install trust anchor from local CA, install ansible on the VM, and execute the following local plays:
	- `ansible-install-acme_sh.yaml` - sets up the renewal of TLS certificates for Vault and Authentik
	- `ansible-install-vault.yaml` - installs Vault as a service, also downloads secrets plugin for proxmox
	- `ansible-install-authentik.yaml` - installs docker, configures docker in a swarm mode, and deploys stack `compose-authentik.yaml`

Depending on the internet speed the scenario above may take ~10 min to deploy everything and initialize all containers.

The following shell variables need to be set before `terraform apply`:
- `TF_VAR_pvetoken` and `TF_VAR_public_ssh_key_for_VM` - format is described [here](https://github.com/graysievert/Homelab-020_Proxmox_basic/tree/master/130-Terraform_access)
- `TF_VAR_TSIG_key` - format: `'key_name.|key_material'`. It is implied that the algorithm is `hmac-sha256`. Please note that `key_name` should be fqdn-formatted, so the trailing dot is required.

The typical way to set variables from stdin would be:
```bash
$ export TF_VAR_terraformvariable=$(cat)
```


## Vault post-install manual steps.
After the  `ansible-install-vault` play is finished, we may proceed to the manual vault initialization.
NOTE: If unattended for a long time, initialization over UI may end up in unknown root token and Shamir keys. For the sake of reliability, it is better to use CLI. Vault executables for client access are available [here](https://developer.hashicorp.com/vault/downloads)

Initialize the Vault:
```bash
$ export VAULT_ADDR=https://aegis.lan:8200

$ vault operator init \
-key-shares=1 \
-key-threshold=1

Unseal Key 1: Base64EncodedUnsealKey
Initial Root Token: hvs.VaultRootTokenContents
```
Write keys and token somewhere safe.
Disclaimer: feel free to choose any number of key shares and the threshold of how many of them are needed to unlock the Vault.

Visit `https://aegis.lan:8200` and try unlocking the Vault with unlock keys, log in using the root token to check its validity, and log out.

Further Vault configuration will be performed via Terraform as described in [Managing Vault configuration via Terraform](/https://github.com/graysievert/Homelab-030_Secrets_and_Auth/tree/master/120-vault_config)

## Authentic post-install manual steps
After the  `ansible-install-authentik` play is finished and the stack is fully deployed (which may take noticeable time) we may proceed with several manual operations:

#### Configure admin user
Visit `https://aegis.lan/if/flow/initial-setup/` and set the email and password for the default  `akadmin` user.
Note: As  Authentik uses HSTS and initially supplies its self-signed certificate, getting through the browser's protection might be problematic. If stuck, try using the VM's IP address instead of the domain name in the URL.

#### Configure TLS certificate
Navigate to `Admin interface`.
Then go to `System->Brands->` and click edit `authentik-default`.
Expand  `Other global settings->Web Certificate` and select `tls` (which is the key pair generated by the `ansible-install-acme_sh` play). Confirm.
After a few minutes when visiting `https://aegis.lan` we should see the certificate signed by our private CA.

### Configure Group and user
Navigate to `Admin interface`.
Then go to `Directory->Groups` and create a group `devops`. Ensure that `Is superuser` is on.
Then go to `Directory->Users` and create user `newton`:
- User type: `internal`
- Email: `newton@homelab.lan`
In user detail use `set password`, in the Groups tab add `newton` to the `devops` group.
Re-login to authentik with the created user.

### Configure OIDC provider for vault
Navigate to `Admin interface`.
Go to `Applications->Providers` and create an OAuth2/OpenID provider:
- Name: `vault`
- Authentication flow: `default-authentication-flow`
- Authorization flow: `default-provider-authorization-explicit-consent`
- Client type: `confidential`
- Client ID: `NotThatSecretButUniqueRandomStringUsedForVault`
- Client Secret: `VeryLongSuperSecretValueThatShouldNotBeStoredInTheCode`
- Redirect URIs/Origins:
`https://aegis.lan:8200/ui/vault/auth/oidc/oidc/callback`
`https://aegis.lan:8200/oidc/callback`
`http://localhost:8250/oidc/callback`
NOTE: `http://localhost:8250/oidc/callback` is required for console clients
- Signing Key: `authentik Self-signed Certificate`
- Subject mode: 	`Based on User's Email`

Go to `Applications->Providers` and create an Application:
- Name: `vault`
- Slug: `vault`
- Provider: `vault`
- Policy engine mode: `any`

Now more details about various endpoints should become available in `Applications->Providers->vault`

Next steps: [Managing Vault configuration via Terraform](https://github.com/graysievert/Homelab-030_Secrets_and_Auth/tree/master/120-vault_config)

